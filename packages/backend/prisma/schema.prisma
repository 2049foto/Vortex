// Vortex Protocol Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Model
// ============================================
model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  email         String?
  name          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  transactions Transaction[]
  preferences  UserPreference?
  achievements UserAchievement[]
  watchlist    Watchlist[]
  alerts       Alert[]
  portfolios   Portfolio[]
  scanHistory  ScanHistory[]

  @@index([walletAddress])
}

// ============================================
// Transaction Model
// ============================================
model Transaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  txHash      String   @unique
  from        String
  to          String
  value       String   // Wei format as string for precision
  chainId     Int
  blockNumber BigInt
  createdAt   DateTime @default(now())

  // Relations
  tokens TransactionToken[]

  @@index([userId, chainId])
  @@index([txHash])
}

// ============================================
// Transaction Token Model
// ============================================
model TransactionToken {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tokenAddress  String
  symbol        String
  name          String
  amount        String      // Wei format as string for precision

  @@index([transactionId, tokenAddress])
}

// ============================================
// Token Cache Model
// ============================================
model TokenCache {
  id             String   @id @default(cuid())
  tokenAddress   String
  chain          String
  riskScore      Int      // 0-100
  riskLevel      String   // SAFE, WARNING, DANGER
  risks          Json     // Array of risk checks
  safe           Boolean
  honeypot       Boolean  @default(false)
  rugpull        Boolean  @default(false)
  transferability Boolean @default(true)
  cachedAt       DateTime @default(now())
  expiresAt      DateTime
  updatedAt      DateTime @updatedAt

  @@unique([tokenAddress, chain])
  @@index([riskLevel, safe])
  @@index([expiresAt])
  @@index([updatedAt])
}

// ============================================
// User Preference Model
// ============================================
model UserPreference {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  darkMode      Boolean  @default(true)
  notifications Boolean  @default(true)
  language      String   @default("en")
  theme         String   @default("dark")
  updatedAt     DateTime @updatedAt
}

// ============================================
// User Achievement Model
// ============================================
model UserAchievement {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       String   // e.g., "first_scan", "high_hodler"
  unlockedAt DateTime @default(now())

  @@unique([userId, type])
  @@index([userId])
}

// ============================================
// Watchlist Model
// ============================================
model Watchlist {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenAddress String
  chain        String
  symbol       String   @default("UNKNOWN")
  name         String   @default("Unknown Token")
  createdAt    DateTime @default(now())

  @@unique([userId, tokenAddress, chain])
  @@index([userId])
}

// ============================================
// Alert Model
// ============================================
model Alert {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // price, risk, volume
  token     String
  condition String   // above, below, equals
  value     Float
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([userId, enabled])
  @@index([token])
}

// ============================================
// Portfolio Model
// ============================================
model Portfolio {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenAddress  String
  chain         String
  symbol        String
  name          String
  balance       String   // Wei format as string for precision
  balanceFormatted Float
  priceUSD      Float
  valueUSD      Float
  riskScore     Int      @default(0)
  category      String   // PREMIUM, DUST, MICRO, RISK
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())

  @@unique([userId, tokenAddress, chain])
  @@index([userId])
  @@index([chain, category])
}

// ============================================
// Scan History Model
// ============================================
model ScanHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address       String   // Scanned wallet address
  chain         String?
  tokensFound   Int      @default(0)
  totalValue    Float    @default(0)
  premiumCount  Int      @default(0)
  dustCount     Int      @default(0)
  microCount    Int      @default(0)
  riskCount     Int      @default(0)
  scanDuration  Int      // milliseconds
  cached        Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([userId, createdAt])
  @@index([address])
  @@index([createdAt])
}

